<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coach Scout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f6f8fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    .chat-container {
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .chat-bubble {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.2rem;
    }

    .chat-bubble img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .message {
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 75%;
      position: relative;
      background: #f1f3f5;
    }

    .chat-bubble.user .message {
      background: #d1e7dd;
      align-self: flex-end;
    }

    .typing {
      font-style: italic;
      opacity: 0.7;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    .timestamp {
      font-size: 0.75rem;
      color: #888;
      margin-top: 2px;
    }

    .input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }

    select, input {
      padding: 10px;
      font-size: 1rem;
      flex: 1 1 100%;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    button {
      padding: 10px 16px;
      font-size: 1rem;
      border: none;
      background: #0077ff;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      flex: 1 1 100%;
    }

    button:hover {
      background: #005ec2;
    }

    @media (min-width: 600px) {
      .input-area {
        flex-wrap: nowrap;
      }
      select, input {
        flex: 1;
      }
      button {
        flex: unset;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container" id="chatContainer">
    <div class="chat-bubble bot">
      <img src="https://xoxnamhylybjzejsuwkr.supabase.co/storage/v1/object/public/coachscout//coachscout.jpg" alt="Coach Scout" />
      <div>
        <div class="message">
          Hello, Iâ€™m <strong>Coach Scout</strong> and Iâ€™m here to help you understand your Canine personality better. ğŸ¾<br />
          Letâ€™s get started! Do you have any questions for me?
        </div>
        <div class="timestamp" id="start-time"></div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <select id="profileSelect">
      <option value="General">ğŸ“‹ General</option>
      <option value="The Guardian">ğŸ›¡ï¸ The Guardian</option>
      <option value="The Investigator">ğŸ•µï¸ The Investigator</option>
      <option value="The Socialiser">ğŸ‰ The Socialiser</option>
      <option value="The Peacekeeper">ğŸ•Šï¸ The Peacekeeper</option>
      <option value="The Performer">ğŸ­ The Performer</option>
      <option value="The Achiever">ğŸ† The Achiever</option>
      <option value="The Connector">ğŸ”— The Connector</option>
      <option value="The Provider">ğŸ The Provider</option>
    </select>
    <input type="text" id="userInput" placeholder="Ask me anything about the test..." />
    <button onclick="sendMessage()">Send</button>
  </div>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const userInput = document.getElementById("userInput");

    document.getElementById("start-time").innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    async function sendMessage() {
      const input = userInput.value.trim();
      const profile = document.getElementById("profileSelect").value;
      if (!input) return;

      appendMessage("user", input);
      userInput.value = "";

      const typingBubble = appendMessage("bot", "Coach Scout is typing...", true);

      const response = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ question: input, profile_name: profile })
      });

      const data = await response.json();
      typingBubble.remove();

      const matched = data.match || "(Couldn't retrieve matched question)";
      appendMessage("bot", `Q: ${matched}\nA: ${data.answer || "Sorry, Iâ€™m not sure about that."}`);
    }

    function appendMessage(sender, text, isTyping = false) {
      const bubble = document.createElement("div");
      bubble.className = `chat-bubble ${sender}`;

      const avatar = document.createElement("img");
      avatar.src = sender === "bot"
        ? "https://xoxnamhylybjzejsuwkr.supabase.co/storage/v1/object/public/coachscout//coachscout.jpg"
        : "https://api.dicebear.com/7.x/thumbs/svg?seed=User";

      const message = document.createElement("div");
      message.className = "message";
      message.textContent = text;
      if (isTyping) message.classList.add("typing");

      const timestamp = document.createElement("div");
      timestamp.className = "timestamp";
      timestamp.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      const msgBox = document.createElement("div");
      msgBox.appendChild(message);
      msgBox.appendChild(timestamp);

      bubble.appendChild(avatar);
      bubble.appendChild(msgBox);

      chatContainer.appendChild(bubble);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      return bubble;
    }

    userInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
